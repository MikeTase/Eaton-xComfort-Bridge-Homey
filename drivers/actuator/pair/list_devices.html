<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script type="text/javascript" src="/homey.js" data-origin="pairing"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .list { margin: 0; padding: 0; list-style: none; }
    .item { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #eee; }
    .actions { margin-top: 16px; }
    button { background: #0078d4; color: #fff; border: 0; padding: 10px 14px; border-radius: 6px; font-size: 14px; }
    button:disabled { background: #9aa0a6; }
    .empty { color: #666; }
  </style>
</head>
<body>
  <h1>Select actuators/dimmers to add</h1>
  <ul id="device-list" class="list"></ul>
  <div id="empty" class="empty" style="display:none;">No devices found.</div>
  <div class="actions">
    <button id="add-btn" disabled>Add selected</button>
  </div>

  <script>
    function onHomeyReady(Homey) {
      const listEl = document.getElementById('device-list');
      const emptyEl = document.getElementById('empty');
      const addBtn = document.getElementById('add-btn');
      let devices = [];

      function render() {
        listEl.innerHTML = '';
        if (!devices.length) {
          emptyEl.style.display = 'block';
          addBtn.disabled = true;
          return;
        }
        emptyEl.style.display = 'none';
        devices.forEach((device, idx) => {
          const li = document.createElement('li');
          li.className = 'item';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.dataset.index = String(idx);
          checkbox.addEventListener('change', updateButtonState);
          const label = document.createElement('label');
          const dataId = device.data && device.data.id ? device.data.id : null;
          label.textContent = device.name || dataId || 'Unnamed';
          li.appendChild(checkbox);
          li.appendChild(label);
          listEl.appendChild(li);
        });
        updateButtonState();
      }

      function updateButtonState() {
        const anyChecked = listEl.querySelector('input[type="checkbox"]:checked');
        addBtn.disabled = !anyChecked;
      }

      function getSelectedDevices() {
        const selected = [];
        listEl.querySelectorAll('input[type="checkbox"]:checked').forEach((cb) => {
          const idx = Number(cb.dataset.index);
          if (!Number.isNaN(idx) && devices[idx]) {
            selected.push(devices[idx]);
          }
        });
        return selected;
      }

      addBtn.addEventListener('click', () => {
        const selected = getSelectedDevices();
        if (!selected.length) return;
        Promise.all(selected.map((device) => Homey.createDevice(device)))
          .then(() => Homey.done())
          .catch((err) => Homey.alert((err && err.message) || String(err)));
      });

      function loadDevices(attempt = 0) {
        Homey.emit('list_devices')
          .then((result) => {
            devices = Array.isArray(result) ? result : [];
            render();
            if (!devices.length && attempt < 5) {
              setTimeout(() => loadDevices(attempt + 1), 1000);
            }
          })
          .catch((err) => Homey.alert((err && err.message) || String(err)));
      }

      loadDevices();
    }
  </script>
</body>
</html>
